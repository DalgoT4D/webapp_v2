name: 'Deploy via SSH'
description: 'Deploy a Docker Compose service to a remote host over SSH'

inputs:
  ssh_host:
    description: 'Target server hostname or IP'
    required: true
  ssh_user:
    description: 'SSH username'
    required: true
  ssh_key:
    description: 'SSH private key'
    required: true
  image_tag:
    description: 'Full Docker image reference (e.g., ghcr.io/org/repo:tag)'
    required: true
  deploy_dir:
    description: 'Remote directory containing docker-compose.yml'
    required: true
  ghcr_token:
    description: 'GHCR authentication token (GITHUB_TOKEN)'
    required: true
  ghcr_user:
    description: 'GHCR username (github.actor)'
    required: true

runs:
  using: 'composite'
  steps:
    - name: Deploy to remote host
      uses: appleboy/ssh-action@v1.2.0
      env:
        GHCR_TOKEN: ${{ inputs.ghcr_token }}
        GHCR_USER: ${{ inputs.ghcr_user }}
      with:
        host: ${{ inputs.ssh_host }}
        username: ${{ inputs.ssh_user }}
        key: ${{ inputs.ssh_key }}
        envs: GHCR_TOKEN,GHCR_USER
        script: |
          set -euo pipefail
          DEPLOY_DIR="${{ inputs.deploy_dir }}"
          NEW_IMAGE="${{ inputs.image_tag }}"
          ENV_FILE="$DEPLOY_DIR/.env"

          # Update WEBAPP_IMAGE in .env (preserve other vars)
          if [ -f "$ENV_FILE" ] && grep -q "^WEBAPP_IMAGE=" "$ENV_FILE"; then
            sed -i "s|^WEBAPP_IMAGE=.*|WEBAPP_IMAGE=$NEW_IMAGE|" "$ENV_FILE"
          else
            echo "WEBAPP_IMAGE=$NEW_IMAGE" >> "$ENV_FILE"
          fi

          cd "$DEPLOY_DIR"
          echo "$GHCR_TOKEN" | docker login ghcr.io -u "$GHCR_USER" --password-stdin
          docker compose pull
          docker compose up -d
          docker logout ghcr.io
